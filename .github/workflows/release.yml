name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Extract version from tag
      id: get_version
      shell: bash
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller pyinstaller-hooks-contrib

    - name: Update settings.json with version
      shell: bash
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        echo "{\"CURRENT_VERSION\": \"$VERSION\"}" > settings.json

    - name: Create PyInstaller spec file
      shell: bash
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        # Copy and modify an existing spec file template
        if [ -f "RFlect_v3.2.0.spec" ]; then
          cp RFlect_v3.2.0.spec RFlect_${VERSION}.spec
        else
          # Use the most recent spec file as template
          LATEST_SPEC=$(ls -t RFlect_*.spec | head -1)
          cp $LATEST_SPEC RFlect_${VERSION}.spec
        fi

    - name: Build executable with PyInstaller
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        pyinstaller RFlect_$VERSION.spec

    - name: Verify executable exists
      shell: bash
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        if [ -f "dist/RFlect_${VERSION}.exe" ]; then
          echo "✓ Executable built successfully"
          ls -lh dist/RFlect_${VERSION}.exe
        else
          echo "✗ Executable not found!"
          ls -la dist/
          exit 1
        fi

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: RFlect-Windows-${{ steps.get_version.outputs.VERSION }}
        path: dist/RFlect_${{ steps.get_version.outputs.VERSION }}.exe
        retention-days: 90

  create-release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Extract version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: RFlect-Windows-${{ steps.get_version.outputs.VERSION }}

    - name: Extract release notes for this version
      id: extract_notes
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        # Extract the relevant section from RELEASE_NOTES.md
        # This is a simplified approach - extracts until next version header
        awk "/## Version ${VERSION#v}/,/## Version [0-9]/" RELEASE_NOTES.md | head -n -1 > release_body.md
        if [ ! -s release_body.md ]; then
          echo "Release notes for $VERSION" > release_body.md
          echo "" >> release_body.md
          echo "See [RELEASE_NOTES.md](RELEASE_NOTES.md) for full changelog." >> release_body.md
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: RFlect_${{ steps.get_version.outputs.VERSION }}.exe
        body_path: release_body.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify release complete
      run: |
        echo "✓ Release ${{ steps.get_version.outputs.VERSION }} created successfully!"
        echo "Download: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }}"
